<!doctype html>
<html lang="ру">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>BitrixCorp — Компании и Контакты</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color: #111; }
		h1 { margin-bottom: 8px; }
		.actions { display: flex; gap: 12px; margin: 12px 0 24px; align-items: center; }
		button { padding: 8px 12px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 6px; }
		button:hover { background: #f7f7f7; }
		.progress { display: none; align-items: center; gap: 8px; border: 1px solid #eee; padding: 6px 10px; border-radius: 8px; color: #333; background: #fafafa; }
		.spinner { width: 14px; height: 14px; border: 2px solid #bbb; border-top-color: #555; border-radius: 50%; animation: spin 1s linear infinite; }
		@keyframes spin { to { transform: rotate(360deg); } }
		.grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
		@media (min-width: 1000px) { .grid { grid-template-columns: 1fr 1fr; } }
		table { width: 100%; border-collapse: collapse; }
		th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
		th { background: #f5f5f5; }
		thead th { position: sticky; top: 0; }
		.table-wrap { max-height: 70vh; overflow: auto; border: 1px solid #eee; }
		.caption { font-weight: 600; margin: 0 0 8px; }
		.alert { background: #fff4f4; border: 1px solid #f3c2c2; color: #8a1f1f; padding: 12px; border-radius: 6px; margin: 12px 0; }
	</style>
</head>
<body>
	<h1>BitrixCorp</h1>
	<p>Компании и контакты</p>

	{% if error_message %}
	<div class="alert">Ошибка конфигурации или доступа к Bitrix24: {{ error_message }}</div>
	{% endif %}

	<div class="actions">
		<button id="btn-generate">Создать 100 компаний и контактов</button>
		<button id="btn-clear">Очистить все компании и контакты</button>
		<div id="progress" class="progress">
			<div class="spinner"></div>
			<span id="progress-text">0%</span>
		</div>
	</div>

	<div class="grid">
		<section>
			<p class="caption">Компании ({{ companies|length }})</p>
			<div class="table-wrap">
				<table>
					<thead>
						<tr>
							<th>#</th>
							<th>Название</th>
							<th>Контактов</th>
							<th>Состав (ФИО)</th>
						</tr>
					</thead>
					<tbody>
						{% for c in companies %}
						<tr>
							<td>{{ loop.index }}</td>
							<td>{{ c.title }}</td>
							<td>{{ c.members|length }}</td>
							<td>
								{% for name in c.members %}
									{{ name }}{% if not loop.last %}, {% endif %}
								{% endfor %}
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</section>

		<section>
			<p class="caption">Контакты ({{ contacts|length }})</p>
			<div class="table-wrap">
				<table>
					<thead>
						<tr>
							<th>#</th>
							<th>Фамилия</th>
							<th>Имя</th>
							<th>Отчество</th>
							<th>Телефон</th>
							<th>Компания</th>
						</tr>
					</thead>
					<tbody>
						{% for p in contacts %}
						<tr>
							<td>{{ loop.index }}</td>
							<td>{{ p.last_name }}</td>
							<td>{{ p.first_name }}</td>
							<td>{{ p.middle_name }}</td>
							<td>{{ p.phone }}</td>
							<td>{{ p.company_title }}</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</section>
	</div>

	<script>
		const secret = JSON.parse('{{ webhook_secret|tojson | safe }}');
		const progressEl = document.getElementById('progress');
		const progressText = document.getElementById('progress-text');
		function url(path) {
			const base = path.includes('?') ? `${path}&` : `${path}?`;
			return secret ? `${base}secret=${encodeURIComponent(secret)}` : path;
		}
		function startSse(endpoint) {
			progressEl.style.display = 'inline-flex';
			progressText.textContent = '0%';
			const es = new EventSource(endpoint);
			es.onmessage = (e) => {
				if (!e.data) return;
				if (e.data === 'done') {
					progressText.textContent = '100%';
					setTimeout(() => { progressEl.style.display = 'none'; location.reload(); }, 400);
					es.close();
					return;
				}
				if (e.data.startsWith('error:')) {
					alert(e.data.replace('error:', '').trim());
					progressEl.style.display = 'none';
					es.close();
					return;
				}
				const val = Math.max(0, Math.min(100, parseInt(e.data, 10)));
				progressText.textContent = `${val}%`;
			};
			es.onerror = () => {
				// В случае разрыва — скрываем индикатор
				progressEl.style.display = 'none';
				es.close();
			};
		}
		document.getElementById('btn-generate').addEventListener('click', async () => {
			startSse(url('/bitrix/webhook/push-stream?count=100'));
		});
		document.getElementById('btn-clear').addEventListener('click', async () => {
			if (!confirm('Удалить ВСЕ контакты и компании?')) return;
			startSse(url('/bitrix/clear-stream'));
		});
	</script>
</body>
</html>
